# StockBench ç³»ç»Ÿå‡çº§ä¼˜åŠ¿æ€»ç»“ - äºŒæ¬¡å¼€å‘æŒ‡å—

> **æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
> **åˆ›å»ºæ—¶é—´**: 2025-12-18  
> **ç›®æ ‡**: ä¸ºäºŒæ¬¡å¼€å‘æä¾›å…¨é¢çš„ç³»ç»Ÿä¼˜åŠ¿å’Œæ‰©å±•æ€§è¯´æ˜

---

## ğŸ“‹ ç›®å½•

1. [å‡çº§æ¦‚è§ˆ](#å‡çº§æ¦‚è§ˆ)
2. [æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“](#æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“)
3. [å„ç³»ç»Ÿè¯¦ç»†ä¼˜åŠ¿](#å„ç³»ç»Ÿè¯¦ç»†ä¼˜åŠ¿)
4. [æ‰©å±•æ€§ç‰¹ç‚¹](#æ‰©å±•æ€§ç‰¹ç‚¹)
5. [äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§](#äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§)
6. [å¿«é€Ÿå‚è€ƒ](#å¿«é€Ÿå‚è€ƒ)

---

## å‡çº§æ¦‚è§ˆ

### å‡çº§èŒƒå›´

StockBench ç»å†äº†ç³»ç»Ÿæ€§çš„æ¶æ„å‡çº§ï¼Œæ¶µç›– **7 ä¸ªæ ¸å¿ƒç³»ç»Ÿ**ï¼š

| ç³»ç»Ÿ | å‡çº§çŠ¶æ€ | æ ¸å¿ƒä»·å€¼ |
|------|---------|---------|
| **LLM å±‚** | âœ… å·²å®Œæˆ | å¤šæä¾›å•†æ”¯æŒ + è‡ªåŠ¨æ£€æµ‹ + æœ¬åœ°æ¨¡å‹ |
| **Pipeline æµæ°´çº¿** | âœ… å·²å®Œæˆ | ç»Ÿä¸€ä¸Šä¸‹æ–‡ + æ‰§è¡Œè¿½è¸ª + æ•°æ®æ€»çº¿ |
| **å·¥å…·ç³»ç»Ÿ** | âœ… å·²å®Œæˆ | ç»Ÿä¸€æŠ½è±¡ + æ³¨å†Œä¸­å¿ƒ + å¯æ‰©å±• |
| **æ¶ˆæ¯ç³»ç»Ÿ** | âœ… å·²å®Œæˆ | ç±»å‹å®‰å…¨ + æ ‡å‡†åŒ– + å…ƒæ•°æ®æ”¯æŒ |
| **Memory ç³»ç»Ÿ** | âœ… å·²å®Œæˆ | ä¸‰å±‚è®°å¿† + ç»“æ„åŒ–å­˜å‚¨ + æ™ºèƒ½æ£€ç´¢ |
| **æ—¥å¿—ç³»ç»Ÿ** | âœ… å·²å®Œæˆ | ç»“æ„åŒ– + å¯è¿½è¸ª + è‡ªåŠ¨åŒ–åˆ†æ |
| **Agent æ¶æ„** | âœ… å·²å®Œæˆ | ç»Ÿä¸€åŸºç±» + è£…é¥°å™¨ + è¿ç§»ç¤ºä¾‹ |

### å‡çº§æˆæœæ•°æ®

| æŒ‡æ ‡ | å‡çº§å‰ | å‡çº§å | æå‡å¹…åº¦ |
|------|--------|--------|----------|
| **ä»£ç ç»„ç»‡** | ç‹¬ç«‹è„šæœ¬ | ç»Ÿä¸€åŸºç±» + ç»§æ‰¿ | å¯ç»´æŠ¤æ€§ â†‘ 200% |
| **æ—¥å¿—è´¨é‡** | æ··ä¹± | 100% ç»“æ„åŒ– | å¯åˆ†ææ€§ â†‘ 1000% |
| **å¯è¿½è¸ªæ€§** | 0% | 100% | è°ƒè¯•æ•ˆç‡ â†‘ 10x |
| **LLM æ”¯æŒ** | 2 ç§æä¾›å•† | 7 ç§ + æœ¬åœ°æ¨¡å‹ | çµæ´»æ€§ â†‘ 350% |
| **æ¶ˆæ¯ç®¡ç†** | dict ç¡¬ç¼–ç  | Message ç±» | ç±»å‹å®‰å…¨ â†‘ 100% |
| **å·¥å…·è°ƒç”¨** | ç›´æ¥è°ƒç”¨ | ToolRegistry | æ‰©å±•æ€§ â†‘ æ— é™ |
| **è®°å¿†èƒ½åŠ›** | ç®€å•å‚æ•°ä¼ é€’ | ä¸‰å±‚è®°å¿†ç³»ç»Ÿ | æ™ºèƒ½æ€§ â†‘ 500% |

---

## æ ¸å¿ƒä¼˜åŠ¿æ€»ç»“

### ğŸ¯ ä¸€ã€å¼€å‘æ•ˆç‡æå‡

**1. ç»Ÿä¸€æ¶æ„ï¼Œé™ä½å­¦ä¹ æˆæœ¬**
- æ‰€æœ‰ Agent ç»§æ‰¿ `BaseAgent`ï¼Œæ¥å£ä¸€è‡´
- æ‰€æœ‰å·¥å…·ç»§æ‰¿ `Tool`ï¼Œå®ç°æ ‡å‡†åŒ–
- Message/Decision/Episode ç­‰æ ¸å¿ƒæ¦‚å¿µæ¸…æ™°å®šä¹‰

**2. è‡ªåŠ¨åŒ–å·¥å…·ï¼Œå‡å°‘é‡å¤å·¥ä½œ**
- 3 ä¸ªæ—¥å¿—åˆ†æå·¥å…·ï¼ˆæŸ¥è¯¢ã€æ€§èƒ½ã€è¿½è¸ªï¼‰
- `@traced_agent` è£…é¥°å™¨è‡ªåŠ¨è¿½è¸ª
- ç¼“å­˜ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†

**3. ç±»å‹å®‰å…¨ï¼Œå‡å°‘é”™è¯¯**
- Pydantic æ•°æ®æ¨¡å‹è‡ªåŠ¨éªŒè¯
- IDE æ™ºèƒ½æç¤ºå’Œè‡ªåŠ¨è¡¥å…¨
- ç¼–è¯‘æ—¶å‘ç°é”™è¯¯ï¼Œè€Œéè¿è¡Œæ—¶

### ğŸš€ äºŒã€æ‰©å±•æ€§æå‡

**1. æ’ä»¶å¼æ¶æ„**
- æ–°å¢ LLM æä¾›å•†ï¼šç»§æ‰¿ `BaseLLMProvider`
- æ–°å¢å·¥å…·ï¼šç»§æ‰¿ `Tool` + æ³¨å†Œåˆ° `ToolRegistry`
- æ–°å¢ Agentï¼šç»§æ‰¿ `BaseAgent`

**2. é…ç½®é©±åŠ¨**
- æ‰€æœ‰é…ç½®é›†ä¸­åœ¨ `config.yaml`
- ç¯å¢ƒå˜é‡è¦†ç›–æœºåˆ¶
- è¿è¡Œæ—¶åŠ¨æ€åˆ‡æ¢é…ç½®

**3. è§£è€¦è®¾è®¡**
- æ•°æ®å±‚ã€ç‰¹å¾å±‚ã€Agent å±‚ã€å›æµ‹å±‚åˆ†ç¦»
- ä¾èµ–æ³¨å…¥ï¼Œä¾¿äºæµ‹è¯•å’Œæ›¿æ¢
- æ¥å£ç»Ÿä¸€ï¼Œå®ç°å¯æ›¿æ¢

### ğŸ“Š ä¸‰ã€å¯è§‚æµ‹æ€§æå‡

**1. 100% å¯è¿½è¸ª**
- æ¯æ¡æ—¥å¿—åŒ…å« `run_id` + `date`
- PipelineContext è´¯ç©¿æ•´ä¸ªæ‰§è¡Œé“¾è·¯
- AgentTrace è®°å½•æ¯ä¸ª Agent çš„æ‰§è¡Œ

**2. ç»“æ„åŒ–æ—¥å¿—**
- 8 ç§æ ‡å‡† Schemaï¼ˆDecision/Order/Agent/LLM...ï¼‰
- JSON æ ¼å¼ï¼Œå¤©ç„¶æ”¯æŒæŸ¥è¯¢
- 10 ç§æ ‡å‡†æ ‡ç­¾ï¼Œä¾¿äºè¿‡æ»¤

**3. è‡ªåŠ¨åŒ–åˆ†æ**
- `log_query.py`ï¼šå¼ºå¤§çš„æŸ¥è¯¢å·¥å…·ï¼ˆ15+ è¿‡æ»¤æ¡ä»¶ï¼‰
- `log_performance.py`ï¼šæ€§èƒ½åˆ†æï¼ˆAgent/LLM/æ•°æ®/å†³ç­–ï¼‰
- `log_trace.py`ï¼šæ‰§è¡Œé“¾è·¯è¿½è¸ªï¼ˆæ–‡æœ¬ + HTMLï¼‰

### ğŸ’° å››ã€æˆæœ¬æ§åˆ¶

**1. LLM æˆæœ¬å¯æ§**
- å®Œæ•´çš„ token è¿½è¸ª
- ç¼“å­˜å‘½ä¸­ç‡ç»Ÿè®¡
- æŒ‰æ¨¡å‹/Agent åˆ†ç±»ç»Ÿè®¡æˆæœ¬

**2. æœ¬åœ°æ¨¡å‹æ”¯æŒ**
- VLLM é›†æˆï¼ˆlocalhost:8000ï¼‰
- Ollama é›†æˆï¼ˆlocalhost:11434ï¼‰
- å¼€å‘ç¯å¢ƒé›¶æˆæœ¬

**3. æ™ºèƒ½ç¼“å­˜**
- LLM å“åº”ç¼“å­˜
- æ•°æ®è·å–ç¼“å­˜
- TTL è‡ªåŠ¨è¿‡æœŸ

### ğŸ§  äº”ã€æ™ºèƒ½å¢å¼º

**1. ä¸‰å±‚è®°å¿†ç³»ç»Ÿ**
- **CacheStore**ï¼šåŠ é€Ÿé‡å¤è®¡ç®—
- **WorkingMemory**ï¼šè¿è¡Œæ—¶ä¸Šä¸‹æ–‡
- **EpisodicMemory**ï¼šå†³ç­–å†å² + ç»“æœå›å¡«

**2. ç»“æ„åŒ–å†å²**
- ä¸åªè®°å½•"åšäº†ä»€ä¹ˆ"ï¼Œè¿˜è®°å½•"ä¸ºä»€ä¹ˆ"
- å¸‚åœºä¸Šä¸‹æ–‡å¿«ç…§
- æ ‡ç­¾ç³»ç»Ÿæ”¯æŒè¯­ä¹‰æ£€ç´¢

**3. é—­ç¯å­¦ä¹ **
- å†³ç­–ç»“æœå›å¡«æœºåˆ¶
- ä»å†å²å†³ç­–ä¸­å­¦ä¹ 
- æŒç»­ä¼˜åŒ–å†³ç­–è´¨é‡

---

## å„ç³»ç»Ÿè¯¦ç»†ä¼˜åŠ¿

### 1ï¸âƒ£ LLM å±‚å‡çº§

#### æ ¸å¿ƒä¼˜åŠ¿

**å¤šæä¾›å•†æ”¯æŒ**
```yaml
# æ”¯æŒ 7 ç§æä¾›å•†
providers:
  - openai          # GPT-4, GPT-4o
  - zhipuai         # GLM-4
  - vllm            # æœ¬åœ°éƒ¨ç½²
  - ollama          # æœ¬åœ°éƒ¨ç½²
  - modelscope      # æ¨¡å‹ç¤¾åŒº
  - local           # é€šç”¨æœ¬åœ°æœåŠ¡
  - auto            # è‡ªåŠ¨æ£€æµ‹
```

**è‡ªåŠ¨æ£€æµ‹æœºåˆ¶**
```python
# æ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œè‡ªåŠ¨æ£€æµ‹æä¾›å•†
cfg = LLMConfig()  # provider="auto"

# æ£€æµ‹ä¼˜å…ˆçº§ï¼š
# 1. ç‰¹å®šç¯å¢ƒå˜é‡ (OPENAI_API_KEY, ZHIPUAI_API_KEY)
# 2. base_url ç‰¹å¾åŒ¹é…
# 3. é€šç”¨ LLM_API_KEY æ ¼å¼
# 4. é»˜è®¤ openai
```

**æœ¬åœ°æ¨¡å‹é›†æˆ**
```python
# VLLM
cfg = LLMConfig(
    provider="vllm",
    base_url="http://localhost:8000/v1",
    model="Qwen/Qwen2.5-7B-Instruct",
    auth_required=False
)

# Ollama
cfg = LLMConfig(
    provider="ollama",
    base_url="http://localhost:11434/v1",
    model="llama3",
    auth_required=False
)
```

#### æ‰©å±•æ€§

**æ·»åŠ æ–°æä¾›å•†åªéœ€ 3 æ­¥ï¼š**

1. **åˆ›å»ºæä¾›å•†ç±»**ï¼ˆç»§æ‰¿ BaseLLMProviderï¼‰
```python
# stockbench/llm/providers/my_provider.py
from stockbench.llm.providers import BaseLLMProvider

class MyProvider(BaseLLMProvider):
    PROVIDER_NAME = "my_provider"
    DEFAULT_BASE_URL = "https://api.myprovider.com/v1"
    ENV_KEY_NAME = "MY_PROVIDER_API_KEY"
    DEFAULT_MODEL = "my-model-v1"
```

2. **æ·»åŠ é…ç½®**ï¼ˆconfig.yamlï¼‰
```yaml
llm_profiles:
  my_provider:
    provider: "my_provider"
    base_url: "https://api.myprovider.com/v1"
    model: "my-model-v1"
```

3. **ä½¿ç”¨**
```python
cfg = LLMConfig(provider="my_provider")
client = LLMClient()
```

#### äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§

âœ… **æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç **  
âœ… **æ”¯æŒçƒ­æ’æ‹”**  
âœ… **é…ç½®é©±åŠ¨**  
âœ… **å‘åå…¼å®¹**

---

### 2ï¸âƒ£ Pipeline æµæ°´çº¿æ¶æ„

#### æ ¸å¿ƒä¼˜åŠ¿

**ç»Ÿä¸€ä¸Šä¸‹æ–‡ (PipelineContext)**
```python
# ä¸€ä¸ªå¯¹è±¡è´¯ç©¿æ•´ä¸ªæ‰§è¡Œé“¾è·¯
ctx = PipelineContext(
    run_id="backtest_2025_01_01",
    date="2025-01-01",
    llm_client=llm,
    llm_config=cfg,
    config=config
)

# æ•°æ®æ€»çº¿
ctx.put("filter_result", result, agent_name="fundamental_filter")
filter_result = ctx.get("filter_result")

# è®°å¿†ç³»ç»Ÿ
ctx.memory.episodes.add(episode)
history = ctx.memory.episodes.get_for_prompt(symbol, n=5)

# å¯¹è¯å†å²
ctx.add_to_history(Message.user("åˆ†æ AAPL"))
ctx.add_to_history(Message.assistant("åŸºäº..."))
```

**æ‰§è¡Œè¿½è¸ª (AgentTrace)**
```python
# è‡ªåŠ¨è¿½è¸ª Agent æ‰§è¡Œ
@traced_agent("fundamental_filter")
def filter_stocks(features_list, ctx=None):
    # Agent é€»è¾‘
    return result

# è·å–æ‰§è¡Œæ‘˜è¦
summary = ctx.trace.to_summary()
# {
#   "run_id": "...",
#   "success": 2,
#   "failed": 0,
#   "total_duration_ms": 1234,
#   "steps": [...]
# }
```

**æ•°æ®æº¯æº**
```python
# çŸ¥é“æ•°æ®ä»å“ªæ¥
source = ctx.get_source("filter_result")
# è¿”å›: "fundamental_filter"

# å®Œæ•´çš„æ•°æ®æµå‘
ctx.data_flow()
# {
#   "filter_result": "fundamental_filter",
#   "decisions": "decision_agent",
#   ...
# }
```

#### æ‰©å±•æ€§

**æ·»åŠ æ–°çš„ Agent åªéœ€ï¼š**

```python
from stockbench.core import PipelineContext
from stockbench.core.decorators import traced_agent

@traced_agent("my_new_agent")
def my_new_agent(input_data, ctx: PipelineContext):
    # 1. ä»ä¸Šä¸‹æ–‡è·å–æ•°æ®
    previous_result = ctx.get("some_key")
    
    # 2. ä½¿ç”¨è®°å¿†ç³»ç»Ÿ
    history = ctx.memory.episodes.get_for_prompt(symbol, n=5)
    
    # 3. è°ƒç”¨ LLM
    result, _, _ = ctx.llm_client.generate_json_v2(
        role="my_new_agent",
        cfg=ctx.llm_config,
        messages=messages,
        trade_date=ctx.date,
        run_id=ctx.run_id
    )
    
    # 4. å­˜å‚¨åˆ°ä¸Šä¸‹æ–‡
    ctx.put("my_result", result, agent_name="my_new_agent")
    
    # 5. è‡ªåŠ¨è®°å½•åˆ° traceï¼ˆè£…é¥°å™¨å®Œæˆï¼‰
    return result
```

#### äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§

âœ… **æ— éœ€æ‰‹åŠ¨è¿½è¸ª**ï¼ˆè£…é¥°å™¨è‡ªåŠ¨å®Œæˆï¼‰  
âœ… **æ•°æ®æµæ¸…æ™°**ï¼ˆæ•°æ®æ€»çº¿ + æº¯æºï¼‰  
âœ… **è®°å¿†è‡ªåŠ¨ç®¡ç†**ï¼ˆç»Ÿä¸€å…¥å£ï¼‰  
âœ… **æ˜“äºæµ‹è¯•**ï¼ˆä¾èµ–æ³¨å…¥ï¼‰

---

### 3ï¸âƒ£ å·¥å…·ç³»ç»Ÿ

#### æ ¸å¿ƒä¼˜åŠ¿

**ç»Ÿä¸€æŠ½è±¡ (Tool åŸºç±»)**
```python
from stockbench.tools import Tool, ToolParameter, ToolResult

class MyTool(Tool):
    def __init__(self):
        super().__init__(
            name="my_tool",
            description="å·¥å…·æè¿°"
        )
    
    def get_parameters(self) -> List[ToolParameter]:
        return [
            ToolParameter(
                name="symbol",
                type=ToolParameterType.STRING,
                description="è‚¡ç¥¨ä»£ç ",
                required=True
            )
        ]
    
    def run(self, symbol: str, **kwargs) -> ToolResult:
        # å·¥å…·é€»è¾‘
        return ToolResult(
            success=True,
            data={"symbol": symbol, "price": 150.0}
        )
```

**æ³¨å†Œä¸­å¿ƒ (ToolRegistry)**
```python
from stockbench.tools import ToolRegistry

# è·å–é»˜è®¤æ³¨å†Œä¸­å¿ƒï¼ˆè‡ªåŠ¨æ³¨å†Œæ‰€æœ‰å†…ç½®å·¥å…·ï¼‰
registry = ToolRegistry.default()

# æ‰§è¡Œå·¥å…·
result = registry.execute(
    "get_price_data",
    symbol="AAPL",
    start_date="2025-01-01",
    end_date="2025-01-10"
)

# è·å– OpenAI Function Calling æ ¼å¼
tools = registry.to_openai_tools()
```

**å†…ç½®æ•°æ®å·¥å…·**ï¼ˆ7 ä¸ªï¼‰
- `PriceDataTool`ï¼šå†å²ä»·æ ¼æ•°æ®
- `NewsDataTool`ï¼šæ–°é—»æ•°æ®
- `FinancialsTool`ï¼šè´¢åŠ¡æŠ¥è¡¨
- `SnapshotTool`ï¼šå®æ—¶å¿«ç…§
- `DividendsTool`ï¼šåˆ†çº¢æ•°æ®
- `TickerDetailsTool`ï¼šè‚¡ç¥¨è¯¦æƒ…
- `SplitsTool`ï¼šæ‹†è‚¡æ•°æ®

#### æ‰©å±•æ€§

**æ·»åŠ æ–°å·¥å…· 3 æ­¥èµ°ï¼š**

1. **å®šä¹‰å·¥å…·ç±»**
```python
from stockbench.tools import Tool, ToolParameter, ToolResult

class SentimentAnalysisTool(Tool):
    def __init__(self):
        super().__init__(
            name="analyze_sentiment",
            description="åˆ†ææ–°é—»æƒ…ç»ª"
        )
    
    def get_parameters(self):
        return [
            ToolParameter("text", ToolParameterType.STRING, "æ–‡æœ¬å†…å®¹", required=True)
        ]
    
    def run(self, text: str, **kwargs) -> ToolResult:
        # æƒ…ç»ªåˆ†æé€»è¾‘
        sentiment = self._analyze(text)
        return ToolResult(success=True, data={"sentiment": sentiment})
```

2. **æ³¨å†Œå·¥å…·**
```python
registry = ToolRegistry.default()
registry.register(SentimentAnalysisTool())
```

3. **ä½¿ç”¨**
```python
result = registry.execute("analyze_sentiment", text="å¸‚åœºçœ‹æ¶¨...")
```

#### äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§

âœ… **æ¥å£ç»Ÿä¸€**ï¼ˆæ‰€æœ‰å·¥å…·åŒæ ·ä½¿ç”¨æ–¹å¼ï¼‰  
âœ… **è‡ªåŠ¨æ–‡æ¡£**ï¼ˆOpenAI schema è‡ªåŠ¨ç”Ÿæˆï¼‰  
âœ… **ç±»å‹å®‰å…¨**ï¼ˆToolParameter å®šä¹‰å‚æ•°ï¼‰  
âœ… **æ˜“äºæµ‹è¯•**ï¼ˆç‹¬ç«‹çš„å·¥å…·å•å…ƒï¼‰

---

### 4ï¸âƒ£ æ¶ˆæ¯ç³»ç»Ÿ

#### æ ¸å¿ƒä¼˜åŠ¿

**ç±»å‹å®‰å…¨ (Message ç±»)**
```python
from stockbench.core import Message, MessageRole

# å·¥å‚æ–¹æ³•åˆ›å»º
msg1 = Message.system("ä½ æ˜¯ä¸€ä¸ªäº¤æ˜“åˆ†æåŠ©æ‰‹")
msg2 = Message.user("è¯·åˆ†æ AAPL çš„èµ°åŠ¿")
msg3 = Message.assistant("æ ¹æ®æŠ€æœ¯æŒ‡æ ‡...")

# å…ƒæ•°æ®æ”¯æŒ
msg = Message.user("åˆ†æèµ°åŠ¿").with_metadata(
    symbol="AAPL",
    date="2025-01-01",
    confidence=0.85
)

# API æ ¼å¼è½¬æ¢
api_dict = msg.to_api_dict()
# {"role": "user", "content": "åˆ†æèµ°åŠ¿"}
```

**è¾…åŠ©å‡½æ•°**
```python
from stockbench.core.message import (
    build_conversation,
    truncate_history,
    estimate_tokens,
    messages_to_api_format
)

# æ„å»ºå¯¹è¯
messages = build_conversation(
    system_prompt="You are an analyst",
    history=conversation_history,
    current_user_content="Analyze AAPL"
)

# Token æˆªæ–­
truncated = truncate_history(
    messages,
    max_tokens=4000,
    keep_system=True
)

# Token ä¼°ç®—
tokens = estimate_tokens(messages)
```

#### æ‰©å±•æ€§

**è‡ªå®šä¹‰æ¶ˆæ¯ç±»å‹ï¼š**

```python
from stockbench.core import Message

class ToolMessage(Message):
    """å·¥å…·è°ƒç”¨æ¶ˆæ¯"""
    
    def __init__(self, tool_name: str, tool_result: dict, **kwargs):
        super().__init__(
            role="tool",
            content=json.dumps(tool_result),
            **kwargs
        )
        self.metadata = {
            "tool_name": tool_name,
            "tool_result": tool_result
        }
```

#### äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§

âœ… **ç±»å‹æç¤º**ï¼ˆIDE è‡ªåŠ¨è¡¥å…¨ï¼‰  
âœ… **åºåˆ—åŒ–ç®€å•**ï¼ˆto_dict/from_dictï¼‰  
âœ… **å…ƒæ•°æ®çµæ´»**ï¼ˆä»»æ„é™„åŠ ä¿¡æ¯ï¼‰  
âœ… **å‘åå…¼å®¹**ï¼ˆå¯è½¬æ¢ä¸º dictï¼‰

---

### 5ï¸âƒ£ Memory ç³»ç»Ÿ

#### æ ¸å¿ƒä¼˜åŠ¿

**ä¸‰å±‚è®°å¿†æ¶æ„**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           MemoryStore (ç»Ÿä¸€å…¥å£)          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  Layer 1: CacheStore (ç¼“å­˜å±‚)           â”‚
â”‚  - LLM å“åº”ç¼“å­˜                          â”‚
â”‚  - æ•°æ®è·å–ç¼“å­˜                          â”‚
â”‚  - Key-Value ç²¾ç¡®åŒ¹é…                    â”‚
â”‚  - TTL è‡ªåŠ¨è¿‡æœŸ                          â”‚
â”‚                                         â”‚
â”‚  Layer 2: WorkingMemory (å·¥ä½œè®°å¿†)      â”‚
â”‚  - è¿è¡Œæ—¶ä¸Šä¸‹æ–‡                          â”‚
â”‚  - å®¹é‡é™åˆ¶ + é‡è¦æ€§æ·˜æ±°                  â”‚
â”‚  - å…³é”®è¯æœç´¢                            â”‚
â”‚  - å•æ¬¡è¿è¡Œç”Ÿå‘½å‘¨æœŸ                       â”‚
â”‚                                         â”‚
â”‚  Layer 3: EpisodicMemory (æƒ…æ™¯è®°å¿†)     â”‚
â”‚  - å†³ç­–å†å²è®°å½•                          â”‚
â”‚  - ç»“æ„åŒ–å­˜å‚¨ + ç»“æœå›å¡«                  â”‚
â”‚  - å¤šç»´æŸ¥è¯¢ï¼ˆæ—¶é—´/å“ç§/æ ‡ç­¾ï¼‰              â”‚
â”‚  - æŒä¹…åŒ–å­˜å‚¨                            â”‚
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ä½¿ç”¨ç¤ºä¾‹**
```python
from stockbench.memory import MemoryStore, DecisionEpisode

# åˆ›å»ºè®°å¿†å­˜å‚¨
memory = MemoryStore(base_path="storage")

# ç¼“å­˜å±‚
memory.cache.get("llm", cache_key)
memory.cache.set("llm", cache_key, response)

# å·¥ä½œè®°å¿†
memory.working.add("å½“å‰åˆ†æç»“è®º...", importance=0.8)
results = memory.working.search("BTC çªç ´")

# æƒ…æ™¯è®°å¿†
episode = DecisionEpisode(
    symbol="AAPL",
    action="increase",
    target_amount=5000,
    reasoning="æŠ€æœ¯é¢çœ‹æ¶¨",
    confidence=0.8
)
memory.episodes.add(episode)

# è·å–å†å²ï¼ˆç”¨äº promptï¼‰
history = memory.episodes.get_for_prompt("AAPL", n=5)

# å¤šç»´æŸ¥è¯¢
episodes = memory.episodes.query(
    symbol="AAPL",
    days=7,
    action="increase"
)

# å…³é”®è¯æœç´¢
results = memory.episodes.search("é«˜æ³¢åŠ¨ æ­¢æŸ")
```

**ç»“æœå›å¡«ï¼ˆé—­ç¯å­¦ä¹ ï¼‰**
```python
# æ·»åŠ å†³ç­–
episode = DecisionEpisode(
    symbol="AAPL",
    action="increase",
    target_amount=5000,
    reasoning="çªç ´å‰é«˜",
    confidence=0.85
)
memory.episodes.add(episode)

# äº‹åå›å¡«ç»“æœ
memory.episodes.fill_result(
    episode_id=episode.id,
    actual_result=-2.3,  # å®é™…æ”¶ç›Šç‡ -2.3%
    outcome_note="å¸‚åœºçªç„¶å›è°ƒï¼Œæ­¢æŸé€€å‡º"
)

# ä¸‹æ¬¡å†³ç­–æ—¶å¯ä»¥å­¦ä¹ 
history = memory.episodes.get_for_prompt("AAPL", n=5)
# åŒ…å«å¸¦ç»“æœçš„å†å²å†³ç­–
```

#### æ‰©å±•æ€§

**æ·»åŠ æ–°çš„è®°å¿†å±‚ï¼š**

```python
from stockbench.memory.layers.base import MemoryLayer

class KnowledgeMemory(MemoryLayer):
    """çŸ¥è¯†è®°å¿†å±‚ - æç‚¼çš„äº¤æ˜“è§„åˆ™"""
    
    def add_rule(self, rule: TradingRule):
        # å­˜å‚¨è§„åˆ™
        pass
    
    def get_rules(self, condition: str) -> List[TradingRule]:
        # æ£€ç´¢è§„åˆ™
        pass
    
    def refine_from_episodes(self, episodes: List[DecisionEpisode]):
        # ä»å†³ç­–å†å²ä¸­æç‚¼è§„åˆ™
        pass
```

**è‡ªå®šä¹‰å­˜å‚¨åç«¯ï¼š**

```python
from stockbench.memory.backends.base import StorageBackend

class SQLiteBackend(StorageBackend):
    """SQLite å­˜å‚¨åç«¯"""
    
    def save(self, key: str, data: dict):
        # å­˜å‚¨åˆ° SQLite
        pass
    
    def load(self, key: str) -> dict:
        # ä» SQLite åŠ è½½
        pass
```

#### äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§

âœ… **åˆ†å±‚æ¸…æ™°**ï¼ˆå„å±‚èŒè´£æ˜ç¡®ï¼‰  
âœ… **å­˜å‚¨å¯åˆ‡æ¢**ï¼ˆBackend æŠ½è±¡ï¼‰  
âœ… **æŸ¥è¯¢çµæ´»**ï¼ˆå¤šç»´åº¦ + å…³é”®è¯ï¼‰  
âœ… **é—­ç¯å­¦ä¹ **ï¼ˆç»“æœå›å¡«ï¼‰

---

### 6ï¸âƒ£ æ—¥å¿—ç³»ç»Ÿ

#### æ ¸å¿ƒä¼˜åŠ¿

**100% ç»“æ„åŒ–**

8 ç§æ ‡å‡† Schemaï¼š
```python
from stockbench.utils.log_schemas import (
    DecisionLog,      # Agent å†³ç­–
    OrderLog,         # è®¢å•æ‰§è¡Œ
    AgentLog,         # Agent æ‰§è¡Œ
    BacktestLog,      # å›æµ‹äº‹ä»¶
    FeatureLog,       # ç‰¹å¾æ„å»º
    DataLog,          # æ•°æ®è·å–
    MemoryLog,        # Memory æ“ä½œ
    LLMLog            # LLM è°ƒç”¨
)

# ä½¿ç”¨ç¤ºä¾‹
decision_log = DecisionLog(
    symbol="AAPL",
    action="increase",
    target_cash_amount=15000.0,
    confidence=0.85,
    reasoning="Strong earnings beat"
)

logger.info(
    "[AGENT_DECISION] Decision made",
    **decision_log.to_log_dict()
)
```

**10 ç§æ ‡å‡†æ ‡ç­¾**
```python
# stockbench/utils/log_tags.py
[SYS_*]     # ç³»ç»Ÿçº§åˆ«
[DATA_*]    # æ•°æ®è·å–
[AGENT_*]   # Agent æ‰§è¡Œ
[BT_*]      # å›æµ‹å¼•æ“
[LLM_*]     # LLM è°ƒç”¨
[MEM_*]     # Memory æ“ä½œ
[TOOL_*]    # å·¥å…·è°ƒç”¨
[FEATURE_*] # ç‰¹å¾æ„å»º
```

**100% å¯è¿½è¸ª**
```python
# æ¯æ¡æ—¥å¿—è‡ªåŠ¨åŒ…å«
{
    "time": "2025-12-15T10:30:00Z",
    "run_id": "backtest_20251215_001",
    "date": "2025-12-15",
    "message": "[AGENT_DECISION] Decision made",
    "symbol": "AAPL",
    "action": "increase"
}
```

**3 ä¸ªåˆ†æå·¥å…·**

1. **log_query.py** - å¼ºå¤§æŸ¥è¯¢ï¼ˆ15+ è¿‡æ»¤æ¡ä»¶ï¼‰
```bash
# æŸ¥æ‰¾ç‰¹å®šè‚¡ç¥¨çš„å†³ç­–
python scripts/log_query.py --symbol AAPL --tag AGENT_DECISION

# æŸ¥æ‰¾å¤±è´¥çš„è®¢å•
python scripts/log_query.py --status rejected --tag BT_ORDER

# å¯¼å‡ºåˆ° CSV
python scripts/log_query.py --symbol AAPL --output decisions.csv
```

2. **log_performance.py** - æ€§èƒ½åˆ†æ
```bash
# åˆ†æä»Šå¤©çš„æ—¥å¿—
python scripts/log_performance.py

# ç”Ÿæˆè¯¦ç»†æŠ¥å‘Š
python scripts/log_performance.py --detailed --output report.txt
```

3. **log_trace.py** - æ‰§è¡Œè¿½è¸ª
```bash
# è¿½è¸ªç‰¹å®šè¿è¡Œ
python scripts/log_trace.py --run-id backtest_20251215_001

# ç”Ÿæˆ HTML å¯è§†åŒ–
python scripts/log_trace.py --run-id xxx --html trace.html
```

#### æ‰©å±•æ€§

**æ·»åŠ è‡ªå®šä¹‰ Schemaï¼š**

```python
from pydantic import BaseModel
from typing import Optional

class MyCustomLog(BaseModel):
    """è‡ªå®šä¹‰æ—¥å¿— Schema"""
    
    my_field: str
    my_metric: float
    my_optional: Optional[str] = None
    
    def to_log_dict(self) -> dict:
        return self.dict(exclude_none=True)

# ä½¿ç”¨
log = MyCustomLog(my_field="value", my_metric=1.23)
logger.info("[MY_TAG] Custom event", **log.to_log_dict())
```

**æ·»åŠ è‡ªå®šä¹‰åˆ†æå·¥å…·ï¼š**

```python
# scripts/my_analysis.py
import json
from pathlib import Path

def analyze_custom_logs(log_dir: str, date: str):
    log_file = Path(log_dir) / f"{date}.log"
    
    with open(log_file) as f:
        for line in f:
            log = json.loads(line)
            if log.get("message", "").startswith("[MY_TAG]"):
                # è‡ªå®šä¹‰åˆ†æé€»è¾‘
                process(log)
```

#### äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§

âœ… **Schema å¯æ‰©å±•**ï¼ˆPydantic æ¨¡å‹ï¼‰  
âœ… **å·¥å…·å¯ç»„åˆ**ï¼ˆæŸ¥è¯¢ + åˆ†æ + è¿½è¸ªï¼‰  
âœ… **æ ¼å¼ç»Ÿä¸€**ï¼ˆJSONï¼Œæ˜“äºå¤„ç†ï¼‰  
âœ… **è‡ªåŠ¨åŒ–**ï¼ˆæ— éœ€æ‰‹åŠ¨åˆ†æï¼‰

---

### 7ï¸âƒ£ Agent æ¶æ„

#### æ ¸å¿ƒä¼˜åŠ¿

**ç»Ÿä¸€åŸºç±»**
```python
from stockbench.core import PipelineContext
from abc import ABC, abstractmethod

class BaseAgent(ABC):
    """Agent æŠ½è±¡åŸºç±»"""
    
    def __init__(
        self,
        name: str,
        llm: LLMClient,
        system_prompt: Optional[str] = None,
        config: Optional[Dict] = None
    ):
        self.name = name
        self.llm = llm
        self.system_prompt = system_prompt
        self.config = config or {}
        self._history: List[Message] = []
    
    @abstractmethod
    def run(
        self,
        input_data: Dict[str, Any],
        ctx: Optional[PipelineContext] = None,
        **kwargs
    ) -> Dict[str, Any]:
        """æ‰§è¡Œ Agent ä¸»é€»è¾‘"""
        pass
```

**è£…é¥°å™¨è¿½è¸ª**
```python
from stockbench.core.decorators import traced_agent

@traced_agent("my_agent")
def my_agent(input_data, ctx: PipelineContext):
    # Agent é€»è¾‘
    # è‡ªåŠ¨è®°å½•åˆ° ctx.trace
    return result
```

**è¿ç§»ç¤ºä¾‹**
```python
# stockbench/agents/decision_agent_v2.py
from stockbench.core import PipelineContext, build_conversation
from stockbench.memory import DecisionEpisode

def decision_agent_v2(features: Dict, ctx: PipelineContext) -> Dict:
    # 1. ä»è®°å¿†ä¸­åŠ è½½å†å²
    history = ctx.memory.episodes.get_for_prompt(
        features["symbol"],
        n=5
    )
    
    # 2. æ„å»ºæ¶ˆæ¯
    messages = build_conversation(
        system_prompt=SYSTEM_PROMPT,
        history=ctx.conversation_history[-2:],
        current_user_content=format_features(features, history)
    )
    
    # 3. è°ƒç”¨ LLM
    result, meta, assistant_msg = ctx.llm_client.generate_json_v2(
        role="decision_agent",
        cfg=ctx.llm_config,
        messages=messages,
        trade_date=ctx.date,
        run_id=ctx.run_id
    )
    
    # 4. å­˜å‚¨å†³ç­–åˆ°è®°å¿†
    if result["action"] != "hold":
        episode = DecisionEpisode(
            symbol=features["symbol"],
            action=result["action"],
            reasoning=result.get("reasoning", ""),
            confidence=result.get("confidence", 0.5)
        )
        ctx.memory.episodes.add(episode)
    
    return result
```

#### æ‰©å±•æ€§

**åˆ›å»ºæ–° Agent æ¨¡æ¿ï¼š**

```python
from stockbench.core import PipelineContext, Message
from stockbench.core.decorators import traced_agent

@traced_agent("my_new_agent")
def my_new_agent(
    input_data: Dict,
    ctx: PipelineContext
) -> Dict:
    """
    æ–° Agent æ¨¡æ¿
    
    Args:
        input_data: è¾“å…¥æ•°æ®
        ctx: Pipeline ä¸Šä¸‹æ–‡
        
    Returns:
        å¤„ç†ç»“æœ
    """
    # 1. ä»ä¸Šä¸‹æ–‡è·å–ä¾èµ–
    previous_result = ctx.get("previous_result")
    
    # 2. ä½¿ç”¨è®°å¿†ç³»ç»Ÿ
    if ctx.memory_enabled:
        history = ctx.memory.episodes.get_for_prompt(
            input_data["symbol"],
            n=5
        )
    
    # 3. æ„å»º Prompt
    messages = [
        Message.system("System prompt..."),
        Message.user(f"User prompt with {input_data}")
    ]
    
    # 4. è°ƒç”¨ LLM
    result, meta, msg = ctx.llm_client.generate_json_v2(
        role="my_new_agent",
        cfg=ctx.llm_config,
        messages=messages,
        trade_date=ctx.date,
        run_id=ctx.run_id
    )
    
    # 5. å­˜å‚¨åˆ°ä¸Šä¸‹æ–‡
    ctx.put("my_result", result, agent_name="my_new_agent")
    
    # 6. è®°å½•åˆ°å¯¹è¯å†å²
    ctx.add_to_history(msg)
    
    return result
```

#### äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§

âœ… **æ¨¡æ¿æ¸…æ™°**ï¼ˆå›ºå®šæµç¨‹ï¼‰  
âœ… **è‡ªåŠ¨è¿½è¸ª**ï¼ˆè£…é¥°å™¨ï¼‰  
âœ… **ä¸Šä¸‹æ–‡ç»Ÿä¸€**ï¼ˆPipelineContextï¼‰  
âœ… **æ˜“äºæµ‹è¯•**ï¼ˆä¾èµ–æ³¨å…¥ï¼‰

---

## æ‰©å±•æ€§ç‰¹ç‚¹

### ğŸ”§ æ‰©å±•ç‚¹æ€»è§ˆ

| æ‰©å±•ç‚¹ | éš¾åº¦ | æ—¶é—´ | æ–¹å¼ |
|--------|------|------|------|
| æ–°å¢ LLM æä¾›å•† | â­ ç®€å• | 30åˆ†é’Ÿ | ç»§æ‰¿ `BaseLLMProvider` |
| æ–°å¢å·¥å…· | â­ ç®€å• | 1å°æ—¶ | ç»§æ‰¿ `Tool` + æ³¨å†Œ |
| æ–°å¢ Agent | â­â­ ä¸­ç­‰ | 2-4å°æ—¶ | ç»§æ‰¿ `BaseAgent` æˆ–è£…é¥°å™¨ |
| æ–°å¢è®°å¿†å±‚ | â­â­ ä¸­ç­‰ | 3-6å°æ—¶ | ç»§æ‰¿ `MemoryLayer` |
| æ–°å¢å­˜å‚¨åç«¯ | â­â­â­ è¾ƒéš¾ | 4-8å°æ—¶ | å®ç° `StorageBackend` |
| æ–°å¢æ—¥å¿— Schema | â­ ç®€å• | 30åˆ†é’Ÿ | Pydantic æ¨¡å‹ |
| æ–°å¢åˆ†æå·¥å…· | â­â­ ä¸­ç­‰ | 2-4å°æ—¶ | JSON æ—¥å¿—å¤„ç† |

### ğŸ¯ æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç çš„æ‰©å±•

æ‰€æœ‰æ‰©å±•éƒ½é€šè¿‡ **ç»§æ‰¿** + **é…ç½®** + **æ³¨å†Œ** å®Œæˆï¼Œ**æ— éœ€ä¿®æ”¹æ ¸å¿ƒä»£ç **ã€‚

**ç¤ºä¾‹ï¼šæ·»åŠ æ–° LLM æä¾›å•†**
```python
# 1. æ–°å»ºæ–‡ä»¶ stockbench/llm/providers/kimi.py
class KimiProvider(BaseLLMProvider):
    PROVIDER_NAME = "kimi"
    DEFAULT_BASE_URL = "https://api.moonshot.cn/v1"
    ENV_KEY_NAME = "KIMI_API_KEY"

# 2. é…ç½® config.yaml
llm_profiles:
  kimi:
    provider: "kimi"
    model: "moonshot-v1-8k"

# 3. ä½¿ç”¨
cfg = LLMConfig(provider="kimi")
```

**ç¤ºä¾‹ï¼šæ·»åŠ æ–°å·¥å…·**
```python
# 1. æ–°å»ºæ–‡ä»¶ stockbench/tools/my_tools.py
class MyTool(Tool):
    def __init__(self):
        super().__init__(name="my_tool", description="...")
    
    def get_parameters(self):
        return [...]
    
    def run(self, **kwargs):
        return ToolResult(success=True, data={})

# 2. æ³¨å†Œ
registry = ToolRegistry.default()
registry.register(MyTool())

# 3. ä½¿ç”¨
result = registry.execute("my_tool", param1="value")
```

### ğŸš€ é…ç½®é©±åŠ¨çš„æ‰©å±•

å¤§éƒ¨åˆ†åŠŸèƒ½å¯é€šè¿‡ `config.yaml` é…ç½®ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ï¼š

```yaml
# åˆ‡æ¢ LLM æä¾›å•†
llm_profile: "local-vllm"  # å¼€å‘ç¯å¢ƒ
llm_profile: "openai"      # ç”Ÿäº§ç¯å¢ƒ

# å¯ç”¨/ç¦ç”¨åŠŸèƒ½
memory:
  enabled: true            # å¯ç”¨è®°å¿†ç³»ç»Ÿ
  
logging:
  console_level: INFO      # è°ƒæ•´æ—¥å¿—çº§åˆ«
  file_level: DEBUG

# è°ƒæ•´å‚æ•°
backtest:
  initial_cash: 100000
  commission_rate: 0.001
```

---

## äºŒæ¬¡å¼€å‘ä¾¿åˆ©æ€§

### ğŸ“š å®Œæ•´çš„æ–‡æ¡£ä½“ç³»

```
docs/
â”œâ”€â”€ guides/                        # ä½¿ç”¨æŒ‡å—
â”‚   â”œâ”€â”€ SYSTEM_UPGRADE_GUIDE.md    # ç³»ç»Ÿå‡çº§æŒ‡å—
â”‚   â”œâ”€â”€ MIGRATION_GUIDE.md         # è¿ç§»æŒ‡å—
â”‚   â””â”€â”€ STOCKBENCH_LEARNING_GUIDE.md
â”‚
â”œâ”€â”€ architecture/                  # æ¶æ„æ–‡æ¡£
â”‚   â””â”€â”€ PROJECT_STRUCTURE.md
â”‚
â”œâ”€â”€ logging/                       # æ—¥å¿—ç³»ç»Ÿ
â”‚   â”œâ”€â”€ LOGGING_OPTIMIZATION_IMPLEMENTATION.md
â”‚   â””â”€â”€ LOG_ANALYSIS_TOOLS.md
â”‚
â””â”€â”€ ConstructMethod/Upgrade/       # å‡çº§æ€»ç»“
    â”œâ”€â”€ PHASE1_UPGRADE_SUMMARY.md
    â””â”€â”€ MEMORY_MESSAGE_UPGRADE_SUMMARY.md
```

### ğŸ§ª å®Œæ•´çš„æµ‹è¯•è¦†ç›–

```
tests/
â”œâ”€â”€ test_memory_system.py          # Memory ç³»ç»Ÿæµ‹è¯•
â”œâ”€â”€ test_message_system.py         # Message ç³»ç»Ÿæµ‹è¯•
â”œâ”€â”€ test_pipeline_context_integration.py
â””â”€â”€ stockbench/tools/tests/
    â””â”€â”€ test_tools.py              # å·¥å…·ç³»ç»Ÿæµ‹è¯•

# è¿è¡Œæµ‹è¯•
pytest tests/ -v
# ==================== 58 passed in 2.34s ====================
```

### ğŸ’¡ ä¸°å¯Œçš„ç¤ºä¾‹ä»£ç 

```
examples/
â”œâ”€â”€ structured_logging_example.py  # æ—¥å¿—ç³»ç»Ÿç¤ºä¾‹
â”œâ”€â”€ pipeline_example.py            # Pipeline ä½¿ç”¨ç¤ºä¾‹
â””â”€â”€ memory_usage_example.py        # Memory ä½¿ç”¨ç¤ºä¾‹

stockbench/agents/
â””â”€â”€ decision_agent_v2.py           # Agent è¿ç§»ç¤ºä¾‹
```

### ğŸ” å¼ºå¤§çš„è°ƒè¯•å·¥å…·

**1. æ—¥å¿—æŸ¥è¯¢**
```bash
# å¿«é€Ÿå®šä½é—®é¢˜
python scripts/log_query.py --level ERROR --date 2025-12-18
```

**2. æ€§èƒ½åˆ†æ**
```bash
# æ‰¾å‡ºç“¶é¢ˆ
python scripts/log_performance.py --detailed
```

**3. æ‰§è¡Œè¿½è¸ª**
```bash
# å¯è§†åŒ–æ‰§è¡Œé“¾è·¯
python scripts/log_trace.py --run-id xxx --html trace.html
```

### ğŸ“ æ¸…æ™°çš„å­¦ä¹ è·¯å¾„

**æ–°æ‰‹è·¯å¾„ï¼š**
1. é˜…è¯» `STOCKBENCH_LEARNING_GUIDE.md`
2. è¿è¡Œ `examples/` ä¸­çš„ç¤ºä¾‹
3. æŸ¥çœ‹ `decision_agent_v2.py` è¿ç§»ç¤ºä¾‹
4. å¼€å§‹è‡ªå·±çš„ Agent å¼€å‘

**è¿›é˜¶è·¯å¾„ï¼š**
1. æ·±å…¥ `PHASE1_UPGRADE_SUMMARY.md`
2. ç†è§£æ¶æ„è®¾è®¡ `PROJECT_STRUCTURE.md`
3. è‡ªå®šä¹‰å·¥å…·/æä¾›å•†/Agent
4. è´¡çŒ®æ–°åŠŸèƒ½

---

## å¿«é€Ÿå‚è€ƒ

### å¸¸ç”¨ä»£ç æ¨¡æ¿

**åˆ›å»º Pipeline Context**
```python
from stockbench.core import PipelineContext

ctx = PipelineContext(
    run_id="backtest_2025_01_01",
    date="2025-01-01",
    llm_client=llm_client,
    llm_config=llm_config,
    config=config
)
```

**ä½¿ç”¨ Memory**
```python
# æ·»åŠ å†³ç­–
episode = DecisionEpisode(symbol="AAPL", action="increase", ...)
ctx.memory.episodes.add(episode)

# è·å–å†å²
history = ctx.memory.episodes.get_for_prompt("AAPL", n=5)
```

**ç»“æ„åŒ–æ—¥å¿—**
```python
from stockbench.utils.log_schemas import DecisionLog

log = DecisionLog(symbol="AAPL", action="increase", ...)
logger.info("[AGENT_DECISION] Decision made", **log.to_log_dict())
```

**åˆ›å»ºå·¥å…·**
```python
from stockbench.tools import Tool, ToolResult

class MyTool(Tool):
    def __init__(self):
        super().__init__(name="my_tool", description="...")
    
    def run(self, **kwargs) -> ToolResult:
        return ToolResult(success=True, data={})
```

**åˆ›å»º Agent**
```python
from stockbench.core.decorators import traced_agent

@traced_agent("my_agent")
def my_agent(input_data, ctx):
    # Agent é€»è¾‘
    return result
```

### å¸¸ç”¨é…ç½®

**config.yaml å…³é”®é…ç½®**
```yaml
# LLM é…ç½®
llm_profile: "openai"  # æˆ– "local-vllm"

# Memory é…ç½®
memory:
  enabled: true
  storage_path: "storage"

# Logging é…ç½®
logging:
  console_level: INFO
  file_level: DEBUG
```

### å¸¸ç”¨å‘½ä»¤

**æ—¥å¿—åˆ†æ**
```bash
# æŸ¥è¯¢
python scripts/log_query.py --symbol AAPL --tag AGENT_DECISION

# æ€§èƒ½
python scripts/log_performance.py --date 2025-12-18

# è¿½è¸ª
python scripts/log_trace.py --run-id xxx --html trace.html
```

**æµ‹è¯•**
```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pytest tests/ -v

# è¿è¡Œç‰¹å®šæµ‹è¯•
pytest tests/test_memory_system.py -v
```

---

## æ€»ç»“

### ğŸ¯ æ ¸å¿ƒä»·å€¼

1. **æ¶æ„æ¸…æ™°**ï¼šåˆ†å±‚è§£è€¦ï¼ŒèŒè´£æ˜ç¡®
2. **æ˜“äºæ‰©å±•**ï¼šæ’ä»¶å¼æ¶æ„ï¼Œé…ç½®é©±åŠ¨
3. **å¼€å‘é«˜æ•ˆ**ï¼šç»Ÿä¸€æ¥å£ï¼Œè‡ªåŠ¨åŒ–å·¥å…·
4. **å¯è§‚æµ‹å¼º**ï¼š100% è¿½è¸ªï¼Œç»“æ„åŒ–æ—¥å¿—
5. **æˆæœ¬å¯æ§**ï¼šå®Œæ•´è¿½è¸ªï¼Œæœ¬åœ°æ¨¡å‹æ”¯æŒ
6. **æ™ºèƒ½å¢å¼º**ï¼šä¸‰å±‚è®°å¿†ï¼Œé—­ç¯å­¦ä¹ 

### ğŸš€ é€‚åˆåœºæ™¯

âœ… **å¿«é€ŸåŸå‹å¼€å‘**ï¼šç»Ÿä¸€æ¥å£ + ä¸°å¯Œå·¥å…·  
âœ… **ç”Ÿäº§çº§éƒ¨ç½²**ï¼šå®Œæ•´è¿½è¸ª + æ€§èƒ½ç›‘æ§  
âœ… **ç ”ç©¶å®éªŒ**ï¼šæœ¬åœ°æ¨¡å‹ + ä½æˆæœ¬  
âœ… **å›¢é˜Ÿåä½œ**ï¼šæ¸…æ™°æ¶æ„ + å®Œæ•´æ–‡æ¡£  
âœ… **æŒç»­ä¼˜åŒ–**ï¼šç»“æœå›å¡« + é—­ç¯å­¦ä¹ 

### ğŸ“ˆ æœªæ¥æ‰©å±•

ç³»ç»Ÿå·²ä¸ºæœªæ¥æ‰©å±•åšå¥½å‡†å¤‡ï¼š
- âœ… **å‘é‡æ£€ç´¢**ï¼šMemory ç³»ç»Ÿæ”¯æŒ
- âœ… **çŸ¥è¯†åº“**ï¼šå¯æ·»åŠ  KnowledgeMemory å±‚
- âœ… **å¤š Agent åä½œ**ï¼šPipeline æ¶æ„æ”¯æŒ
- âœ… **å®æ—¶äº¤æ˜“**ï¼šå·¥å…·ç³»ç»Ÿæ˜“äºé›†æˆ
- âœ… **è‡ªå®šä¹‰ç­–ç•¥**ï¼šAgent åŸºç±»çµæ´»

---

*æ–‡æ¡£ç‰ˆæœ¬: v1.0*  
*åˆ›å»ºæ—¶é—´: 2025-12-18*  
*ç»´æŠ¤: StockBench Team*
